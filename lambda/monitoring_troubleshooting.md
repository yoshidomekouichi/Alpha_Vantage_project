# Lambda関数のモニタリングとトラブルシューティング

このドキュメントでは、Lambda関数のモニタリング方法とトラブルシューティングについて説明します。

## モニタリング

### CloudWatchログの確認

1. Lambda関数の「モニタリング」タブを選択します
2. 「ログ」セクションで「CloudWatchでログを表示」をクリックします
3. 最新のログストリームを選択します
4. ログを確認します

Lambda関数の実行ログには以下の情報が含まれています：

- Lambda関数の開始・終了時刻
- 実行時間
- メモリ使用量
- fetch_daily.pyの実行結果
- エラーメッセージ（エラーが発生した場合）

### CloudWatchメトリクスの確認

1. Lambda関数の「モニタリング」タブを選択します
2. 以下のメトリクスを確認できます：
   - 呼び出し回数
   - エラー数
   - 実行時間
   - メモリ使用量
   - スロットリング

### CloudWatchアラームの設定

重要なメトリクスに対してアラームを設定することで、問題が発生した場合に通知を受け取ることができます：

1. Lambda関数の「モニタリング」タブを選択します
2. 「メトリクス」セクションで、アラームを設定したいメトリクスの「アラームの作成」をクリックします
3. アラームの条件を設定します（例：エラー数が1以上の場合）
4. 通知方法を設定します（例：SNSトピックにメール通知）
5. アラーム名を入力します
6. 「アラームの作成」をクリックします

## トラブルシューティング

### 一般的な問題と解決策

#### Lambda関数がタイムアウトする

**症状**: Lambda関数の実行が途中で終了し、CloudWatchログに「Task timed out after X seconds」というメッセージが表示される

**解決策**:
1. Lambda関数のタイムアウト設定を長くします（最大15分）
   - 「設定」タブ→「一般設定」→「編集」→「タイムアウト」
2. メモリ割り当てを増やします（処理速度が向上します）
   - 「設定」タブ→「一般設定」→「編集」→「メモリ」
3. 処理を最適化して実行時間を短縮します
   - 不要なAPI呼び出しを削減
   - データ処理を効率化

#### S3へのアクセスエラー

**症状**: CloudWatchログに「Access Denied」や「NoSuchBucket」などのS3関連のエラーメッセージが表示される

**解決策**:
1. IAMロールのS3アクセス権限を確認します
   - 「設定」タブ→「アクセス権限」→ロール名をクリック→ポリシーを確認
2. S3バケット名が正しいか確認します
   - 環境変数の`S3_BUCKET`を確認
3. S3バケットのポリシーを確認します
   - S3コンソールでバケットを選択→「アクセス権限」→「バケットポリシー」

#### APIキーのエラー

**症状**: CloudWatchログに「Invalid API key」や「API call frequency exceeded」などのAPIエラーメッセージが表示される

**解決策**:
1. 環境変数に正しいAPIキーが設定されているか確認します
   - 「設定」タブ→「環境変数」→`ALPHA_VANTAGE_API_KEY`を確認
2. APIキーの制限に達していないか確認します
   - Alpha Vantage APIの利用制限を確認
   - 必要に応じて有料プランにアップグレード

#### Lambda関数のデプロイパッケージが大きすぎる

**症状**: Lambda関数のデプロイ時に「The unzipped size of your deployment package is larger than the maximum allowed size」というエラーメッセージが表示される

**解決策**:
1. デプロイパッケージのサイズを最適化します
   - 不要なライブラリを削除
   - 必要なライブラリのみをインストール
   - ソースコードから不要なファイルを削除
2. Lambda Layersを使用して共通ライブラリを分離します
3. 大きなファイルはS3に保存し、Lambda関数内でダウンロードするようにします

### ログの解析

CloudWatchログを効果的に解析するためのヒント：

1. ログフィルタを使用して特定のメッセージを検索します
   - エラーメッセージ: `ERROR`
   - 警告メッセージ: `WARNING`
   - 特定のシンボル: `symbol=AAPL`
2. CloudWatch Insightsを使用して高度なクエリを実行します
   - エラー数のカウント: `filter @message like "ERROR" | stats count(*) as errorCount`
   - 実行時間の平均: `filter @message like "execution time" | parse @message "execution time: * seconds" as executionTime | stats avg(executionTime) as avgExecutionTime`
3. ログエクスポート機能を使用してログをS3にエクスポートし、詳細な分析を行います

### 定期的なメンテナンス

Lambda関数を安定して運用するための定期的なメンテナンス作業：

1. デプロイパッケージの依存ライブラリを定期的に更新します
2. CloudWatchログを定期的に確認し、エラーや警告がないか監視します
3. Lambda関数のパフォーマンスメトリクスを定期的に確認し、必要に応じてリソース設定を調整します
4. テスト実行を定期的に行い、正常に動作することを確認します
