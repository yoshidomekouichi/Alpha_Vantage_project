# AWS管理コンソールからLambda関数を作成する手順

このドキュメントでは、AWS管理コンソールを使って`fetch_daily.py`を毎朝7時に実行するLambda関数を作成する手順を説明します。

## 1. Lambda関数の作成

1. AWSマネジメントコンソールにログインします
2. Lambda サービスを選択します
3. 「関数の作成」をクリックします
4. 「一から作成」を選択します
5. 関数名を「FetchDailyLambda」と入力します
6. ランタイムに「Python 3.9」を選択します
7. 「実行ロール」セクションで、「基本的なLambdaアクセス権限で新しいロールを作成」を選択します
   - これにより、Lambda関数の基本的な実行権限を持つ新しいロールが自動的に作成されます
8. 「関数の作成」をクリックします

## 2. Lambda関数のコードをアップロード

1. 作成した関数の「コード」タブで「アップロード元」を選択し、「.zip ファイル」を選択します
2. `lambda/fetch_daily_lambda.zip`をアップロードします
3. 「保存」をクリックします

## 3. 関数の設定

1. 「設定」タブで「一般設定」を選択し、「編集」をクリックします
2. ハンドラーに「fetch_daily_lambda.lambda_handler」と入力します
3. タイムアウトを「5分」に設定します
4. メモリを「256 MB」に設定します
5. 「保存」をクリックします

## 4. 環境変数の設定

1. 「設定」タブで「環境変数」を選択し、「編集」をクリックします
2. 以下の環境変数を追加します：
   - `ALPHA_VANTAGE_API_KEY`: Alpha Vantage APIキー
   - `MOCK_MODE`: `False`（本番モード）
   - `SAVE_TO_S3`: `True`（S3に保存する）
   - `S3_BUCKET`: `s3-data-uploader-bucket`
   - `S3_PREFIX_PROD`: `stock-data-prod`
   - `CUSTOM_AWS_REGION`: `ap-northeast-1`（注：AWS_REGIONは予約語なので使用できません）
3. 「保存」をクリックします

## 5. アクセス権限の設定

1. 「設定」タブで「アクセス権限」を選択します
2. 「実行ロール」セクションで、自動的に作成されたロール名をクリックします
   - これにより、IAMコンソールの新しいタブが開きます
3. 「アクセス権限ポリシー」セクションで「アクセス権限を追加」→「ポリシーをアタッチ」をクリックします
4. 検索ボックスに「S3」と入力し、「AmazonS3FullAccess」を選択します
   - または、より制限されたポリシーを作成することもできます
5. 「ポリシーをアタッチ」をクリックします
6. Lambda関数のタブに戻ります

## 6. EventBridgeを使ったスケジュール設定

1. Lambda関数の「設定」タブで「トリガー」を選択します
2. 「トリガーを追加」をクリックします
3. トリガーの設定で「EventBridge (CloudWatch Events)」を選択します
4. 「新規ルールの作成」を選択します
5. ルール名を「FetchDailyLambdaSchedule」と入力します
6. ルールタイプで「スケジュール式」を選択します
7. スケジュール式に `cron(0 22 * * ? *)` を入力します（UTC時間で22時 = 日本時間で朝7時）
8. 「追加」をクリックします

## 7. Lambda関数のテスト実行

1. Lambda関数の「テスト」タブを選択します
2. 「テストイベント」で「新しいテストイベント」を選択します
3. テストイベント名を「TestEvent」と入力します
4. テストイベントの内容はデフォルトのままでOKです
5. 「保存」をクリックします
6. 「テスト」をクリックします
7. 実行結果を確認します

## 8. CloudWatchでログを確認

1. Lambda関数の「モニタリング」タブを選択します
2. 「ログ」セクションで「CloudWatchでログを表示」をクリックします
3. 最新のログストリームを選択します
4. ログを確認します

## 9. トラブルシューティング

### Lambda関数がタイムアウトする場合

- Lambda関数のタイムアウト設定を長くします（最大15分）
- メモリ割り当てを増やします（処理速度が向上します）

### S3へのアクセスエラーが発生する場合

- IAMロールのS3アクセス権限を確認します
- S3バケット名が正しいか確認します
- S3バケットのポリシーを確認します

### APIキーのエラーが発生する場合

- 環境変数に正しいAPIキーが設定されているか確認します
- APIキーの制限に達していないか確認します
